<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Audiogram → TIB (FB S/N+4)</title>
<style>
  :root { --bg:#fff; --fg:#111; --muted:#6b7280; --border:#e5e7eb; --accent:#2563eb; }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:16px system-ui,-apple-system,Segoe UI,Roboto}
  h1{font-size:24px;margin:16px 0}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .grid{display:grid;grid-template-columns:2fr 1fr;gap:16px}
  .card{border:1px solid var(--border);border-radius:14px;padding:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
  input[type="number"],input[type="text"]{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px}
  .btn{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .muted{color:var(--muted);font-size:13px}
  .note{background:#f8fafc;border:1px solid var(--border);border-radius:10px;padding:8px;font-size:14px}
  .drop{padding:24px;border:2px dashed var(--border);border-radius:12px;text-align:center;color:var(--muted);background:#f9fafb}
  .drop.active{border-color:var(--accent);background:#eff6ff;color:#1e3a8a}
  canvas{width:100%;border-radius:12px;box-shadow:0 1px 4px rgba(0,0,0,.06)}
  code{padding:0 4px;border:1px solid var(--border);border-radius:6px;background:#f3f4f6}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <h1>Audiogram → TIB (FB S/N+4)</h1>
  <div class="grid">
    <!-- VÄNSTER: Bildområde -->
    <div class="card" id="leftCard">
      <div class="row">
        <input type="file" id="file" accept="image/*">
        <button class="btn" id="clearBtn" style="display:none">Rensa bild</button>
        <button class="btn" id="pasteBtn" title="Kräver HTTPS och klick">Klistra in från urklipp</button>
        <span class="muted">Tips: ta skärmklipp (Win+Shift+S) och tryck <b>Ctrl+V</b> här.</span>
      </div>
      <div id="drop" class="drop">Släpp bild här, välj fil eller tryck <b>Ctrl+V</b>.</div>
      <img id="img" style="display:none" alt="">
      <canvas id="canvas" style="display:none"></canvas>
      <p class="muted" id="hint" style="display:none;margin-top:8px"></p>
    </div>

    <!-- HÖGER: Parametrar och resultat -->
    <div class="card">
      <div class="row">
        <div style="flex:1">
          <div class="muted">Födelseår</div>
          <input id="birth" type="text" placeholder="t.ex. 1993">
        </div>
      </div>
      <div class="row">
        <div style="flex:1">
          <div class="muted">Topp dB (y-axel)</div>
          <input id="topdb" type="number" value="0">
        </div>
        <div style="flex:1">
          <div class="muted">Botten dB (y-axel)</div>
          <input id="botdb" type="number" value="120">
        </div>
      </div>

      <div class="note" id="thrBox">
        <div style="font-weight:600;margin-bottom:4px">Avlästa trösklar (dB HL)</div>
        <div>3 kHz: <b id="v3">–</b></div>
        <div>4 kHz: <b id="v4">–</b></div>
        <div>6 kHz: <b id="v6">–</b></div>
      </div>

      <div class="note" style="margin-top:8px">
        <div>Ålder (avrundad 5 år): <b id="ageR">–</b></div>
        <div>DTMV 3/4/6 (medel): <b id="dtmv">–</b></div>
        <div>DTMV avrundad (5 dB): <b id="dtmvR">–</b></div>
      </div>

      <div style="margin:12px 0;font-size:18px">
        Förväntat tal-i-brus (FB S/N+4): <b id="tib">–</b>
        <button class="btn" id="copyBtn" style="margin-left:8px">Kopiera</button>
      </div>

      <div class="row"><button class="btn" id="resetBtn">Rensa klick</button></div>
      <p class="muted">Om audiogrammet har annan skala (t.ex. topp = −10 dB, botten = 110 dB), ändra fälten ovan och kalibrera om (klicka först på 0 dB och nedersta linjen).</p>
    </div>
  </div>
</div>

<script>
  // --- Data ---
  const AGE_BINS = [20,25,30,35,40,45,50,55,60,65,70,75,80];
  const DTMV_BINS = [0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80];
  const MATRIX = {
    20:[84,82,80,80,78,76,74,72,70,68,66,64,62,60,58,54,50],
    25:[84,82,80,80,78,76,74,72,70,68,64,64,62,60,58,54,50],
    30:[84,82,80,80,78,76,72,70,70,68,66,64,62,58,56,54,48],
    35:[84,82,80,78,76,74,72,70,68,66,62,60,58,54,50,48,44],
    40:[84,82,80,78,76,74,72,70,68,64,62,58,56,54,50,46,44],
    45:[84,82,80,78,76,74,72,68,68,66,64,60,56,54,52,48,42],
    50:[84,82,80,78,76,74,70,68,66,66,64,60,56,52,50,46,40],
    55:[84,82,80,78,76,74,70,68,68,64,62,58,54,52,48,44,40],
    60:[84,82,80,78,76,72,70,66,64,60,56,54,50,46,44,38,36],
    65:[84,82,80,78,76,72,70,66,64,60,56,50,48,44,42,38,34],
    70:[84,82,80,78,74,72,68,66,62,58,54,50,46,44,40,38,32],
    75:[84,82,80,78,74,72,68,66,60,56,54,48,46,42,38,34,32],
    80:[84,82,80,78,74,72,68,64,60,56,52,48,44,40,34,32,28],
  };
  const round5 = x => Math.round(x/5)*5;
  const nearestLower = (arr,v) => arr.reduce((a,b)=> b<=v?b:a, arr[0]);

  // --- Elements ---
  const fileEl = document.getElementById('file');
  const dropEl = document.getElementById('drop');
  const imgEl  = document.getElementById('img');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const hint = document.getElementById('hint');
  const clearBtn = document.getElementById('clearBtn');
  const pasteBtn = document.getElementById('pasteBtn');

  const birthEl = document.getElementById('birth');
  const topdbEl = document.getElementById('topdb');
  const botdbEl = document.getElementById('botdb');
  const v3El = document.getElementById('v3'), v4El = document.getElementById('v4'), v6El = document.getElementById('v6');
  const ageREl = document.getElementById('ageR'), dtmvEl = document.getElementById('dtmv'), dtmvREl = document.getElementById('dtmvR');
  const tibEl = document.getElementById('tib');
  const copyBtn = document.getElementById('copyBtn');
  const resetBtn = document.getElementById('resetBtn');

  // --- State ---
  let calTopY = null, calBotY = null;
  let pt3 = null, pt4 = null, pt6 = null;
  let thresholds = {k3:undefined,k4:undefined,k6:undefined};

  // --- Image loading helpers ---
  function loadBlob(blob){
    if(!blob) return;
    const url = URL.createObjectURL(blob);
    imgEl.src = url;
    imgEl.onload = () => {
      canvas.style.display = '';
      dropEl.style.display = 'none';
      clearBtn.style.display = '';
      draw();
      hint.style.display = '';
      setHint('Klicka först på 0 dB-linjen (överst).');
      resetClicks(true);
    };
  }
  function handleFile(file){
    if(!file) return;
    if(!file.type.startsWith('image/')){ alert('Endast bildfiler.'); return; }
    loadBlob(file);
  }

  // File input
  fileEl.addEventListener('change', e => handleFile(e.target.files?.[0]));

  // Drag & drop
  ;['dragenter','dragover'].forEach(ev=>dropEl.addEventListener(ev, e=>{
    e.preventDefault(); e.stopPropagation(); dropEl.classList.add('active');
  }));
  ;['dragleave','drop'].forEach(ev=>dropEl.addEventListener(ev, e=>{
    e.preventDefault(); e.stopPropagation(); dropEl.classList.remove('active');
  }));
  dropEl.addEventListener('drop', e => handleFile(e.dataTransfer.files?.[0]));

  // Paste (Ctrl+V)
  window.addEventListener('paste', e=>{
    const items = e.clipboardData?.items || [];
    for(const it of items){
      if(it.type.startsWith('image/')){
        const blob = it.getAsFile(); if(blob){ loadBlob(blob); e.preventDefault(); break; }
      }
    }
  });

  // Clipboard read button (needs HTTPS + user gesture)
  pasteBtn.addEventListener('click', async ()=>{
    try{
      const items = await navigator.clipboard.read();
      for(const item of items){
        for(const type of item.types){
          if(type.startsWith('image/')){
            const blob = await item.getType(type);
            loadBlob(blob); return;
          }
        }
      }
      alert('Ingen bild i urklipp.');
    }catch(err){ alert('Kunde inte läsa urklipp: '+err); }
  });

  clearBtn.addEventListener('click', ()=>{
    canvas.style.display = 'none';
    dropEl.style.display = '';
    imgEl.src = '';
    resetClicks();
    tibEl.textContent = '–';
  });

  // --- Clicks on canvas ---
  canvas.addEventListener('click', e=>{
    const r = canvas.getBoundingClientRect();
    const x = e.clientX - r.left;
    const y = e.clientY - r.top;

    if(calTopY===null){ calTopY = y; setHint('Bra. Klicka nu på nedersta linjen ('+botdbEl.value+' dB).'); draw(); return; }
    if(calBotY===null){ calBotY = y; setHint('OK. Klicka på punkten vid 3 kHz.'); draw(); return; }
    if(!pt3){ pt3 = {x,y}; setHint('Klicka på punkten vid 4 kHz.'); draw(); return; }
    if(!pt4){ pt4 = {x,y}; setHint('Klicka på punkten vid 6 kHz.'); draw(); return; }
    if(!pt6){ pt6 = {x,y}; setHint('Klart. Du kan rensa klick eller ändra parametrar.'); draw(); return; }
  });

  resetBtn.addEventListener('click', ()=>resetClicks());
  function resetClicks(keepHint){
    calTopY = calBotY = null; pt3 = pt4 = pt6 = null;
    thresholds = {k3:undefined,k4:undefined,k6:undefined};
    v3El.textContent = v4El.textContent = v6El.textContent = '–';
    dtmvEl.textContent = dtmvREl.textContent = '–';
    if(!keepHint) setHint('Klicka först på 0 dB-linjen (överst).');
    draw();
    updateAll();
  }

  function setHint(t){ hint.textContent = t; }

  // --- Drawing ---
  function draw(){
    if(!imgEl.src) return;
    const maxW = Math.min(1000, window.innerWidth - 64);
    const ratio = imgEl.naturalWidth / imgEl.naturalHeight;
    const w = maxW, h = Math.round(w/ratio);
    canvas.width = w; canvas.height = h;
    ctx.clearRect(0,0,w,h);
    ctx.drawImage(imgEl,0,0,w,h);

    function dot(p,label){
      if(!p) return;
      ctx.beginPath(); ctx.arc(p.x, p.y, 6, 0, Math.PI*2); ctx.fillStyle = '#111'; ctx.fill();
      ctx.fillStyle='#111'; ctx.font='12px system-ui'; ctx.fillText(label, p.x+8, p.y-8);
    }
    if(calTopY!=null)  dot({x:12,y:calTopY}, '0 dB');
    if(calBotY!=null)  dot({x:12,y:calBotY}, botdbEl.value+' dB');
    dot(pt3,'3 kHz'); dot(pt4,'4 kHz'); dot(pt6,'6 kHz');

    // Update thresholds if possible
    if(pt3&&pt4&&pt6&&calTopY!=null&&calBotY!=null){
      const k3 = yToDb(pt3.y), k4 = yToDb(pt4.y), k6 = yToDb(pt6.y);
      thresholds = {k3,k4,k6};
      v3El.textContent = k3.toFixed(1);
      v4El.textContent = k4.toFixed(1);
      v6El.textContent = k6.toFixed(1);
      const mean = (k3+k4+k6)/3;
      dtmvEl.textContent = mean.toFixed(1)+' dB';
      dtmvREl.textContent = round5(mean)+' dB';
    }
    updateAll();
  }

  function yToDb(y){
    const top = Number(topdbEl.value), bot = Number(botdbEl.value);
    if(calTopY==null || calBotY==null) return NaN;
    const frac = (y - calTopY) / (calBotY - calTopY);
    return top + frac*(bot - top);
  }

  // --- Outputs ---
  function updateAll(){
    const by = birthEl.value;
    let age, ageR, dtmv, dtmvR, tib;
    if(/^[0-9]{4}$/.test(by)){ age = new Date().getFullYear() - Number(by); ageR = round5(age); }
    const {k3,k4,k6} = thresholds;
    if(k3!=null && k4!=null && k6!=null){
      dtmv = (k3+k4+k6)/3; dtmvR = round5(dtmv);
    }
    if(ageR!=null && dtmvR!=null){
      const aKey = nearestLower(AGE_BINS, ageR);
      const dKey = nearestLower(DTMV_BINS, dtmvR);
      const col = DTMV_BINS.indexOf(dKey);
      tib = MATRIX[aKey][col];
    }
    ageREl.textContent = ageR ?? '–';
    if(dtmv!=null){ dtmvEl.textContent = dtmv.toFixed(1)+' dB'; dtmvREl.textContent = dtmvR+' dB'; }
    tibEl.textContent = tib!=null ? (tib+'%') : '–';
  }

  birthEl.addEventListener('input', updateAll);
  topdbEl.addEventListener('input', draw);
  botdbEl.addEventListener('input', draw);

  copyBtn.addEventListener('click', async ()=>{
    const t = tibEl.textContent;
    if(!t || t==='–') return;
    try{ await navigator.clipboard.writeText(t.replace('%','')); alert('Kopierat: '+t); }catch(e){}
  });
</script>
</body>
</html>

