<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Audiogram → TIB (FB S/N+4)</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-white text-gray-900">
  <div id="root"></div>

  <script type="module">
    import React, { useEffect, useRef, useState } from "https://esm.sh/react@18.2.0";
    import { createRoot } from "https://esm.sh/react-dom@18.2.0/client";

    const AGE_BINS = [20,25,30,35,40,45,50,55,60,65,70,75,80];
    const DTMV_BINS = [0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80];
    const MATRIX = {
      20: [84,82,80,80,78,76,74,72,70,68,66,64,62,60,58,54,50],
      25: [84,82,80,80,78,76,74,72,70,68,64,64,62,60,58,54,50],
      30: [84,82,80,80,78,76,72,70,70,68,66,64,62,58,56,54,48],
      35: [84,82,80,78,76,74,72,70,68,66,62,60,58,54,50,48,44],
      40: [84,82,80,78,76,74,72,70,68,64,62,58,56,54,50,46,44],
      45: [84,82,80,78,76,74,72,68,68,66,64,60,56,54,52,48,42],
      50: [84,82,80,78,76,74,70,68,66,66,64,60,56,52,50,46,40],
      55: [84,82,80,78,76,74,70,68,68,64,62,58,54,52,48,44,40],
      60: [84,82,80,78,76,72,70,66,64,60,56,54,50,46,44,38,36],
      65: [84,82,80,78,76,72,70,66,64,60,56,50,48,44,42,38,34],
      70: [84,82,80,78,74,72,68,66,62,58,54,50,46,44,40,38,32],
      75: [84,82,80,78,74,72,68,66,60,56,54,48,46,42,38,34,32],
      80: [84,82,80,78,74,72,68,64,60,56,52,48,44,40,34,32,28],
    };

    const round5 = (x) => Math.round(x/5)*5;
    const nearestLower = (sorted, value) => sorted.reduce((a,v)=> v<=value?v:a, sorted[0]);

    function App() {
      const [birthYear, setBirthYear] = useState("");
      const [topDb, setTopDb] = useState(0);
      const [bottomDb, setBottomDb] = useState(120);
      const [image, setImage] = useState(null);
      const [dropActive, setDropActive] = useState(false);

      const canvasRef = useRef(null);
      const imgRef = useRef(null);
      const dropRef = useRef(null);

      const [calTopY, setCalTopY] = useState(null);
      const [calBottomY, setCalBottomY] = useState(null);
      const [pt3, setPt3] = useState(null);
      const [pt4, setPt4] = useState(null);
      const [pt6, setPt6] = useState(null);

      const [thresholds, setThresholds] = useState({});

      function loadBlob(blob) {
        if (!blob) return;
        const url = URL.createObjectURL(blob);
        setImage(url); clearAll();
      }
      function handleFile(file) {
        if (!file) return;
        if (!file.type.startsWith('image/')) return alert('Endast bildfiler stödjs.');
        loadBlob(file);
      }

      // Drag & drop
      useEffect(()=>{
        const el = dropRef.current;
        if (!el) return;
        const prevent = (e)=>{ e.preventDefault(); e.stopPropagation(); };
        const onEnter = (e)=>{ prevent(e); setDropActive(true); };
        const onLeave = (e)=>{ prevent(e); setDropActive(false); };
        const onDrop = (e)=>{
          prevent(e); setDropActive(false);
          const f = e.dataTransfer.files?.[0];
          handleFile(f);
        };
        el.addEventListener('dragenter', onEnter);
        el.addEventListener('dragover', onEnter);
        el.addEventListener('dragleave', onLeave);
        el.addEventListener('drop', onDrop);
        return ()=>{
          el.removeEventListener('dragenter', onEnter);
          el.removeEventListener('dragover', onEnter);
          el.removeEventListener('dragleave', onLeave);
          el.removeEventListener('drop', onDrop);
        };
      },[]);

      // Global Ctrl+V paste
      useEffect(()=>{
        const onPaste = (e)=>{
          const items = e.clipboardData?.items || [];
          for (const it of items) {
            if (it.type.startsWith('image/')) {
              const blob = it.getAsFile();
              if (blob) { loadBlob(blob); e.preventDefault(); break; }
            }
          }
        };
        window.addEventListener('paste', onPaste);
        return ()=> window.removeEventListener('paste', onPaste);
      },[]);

      // Optional explicit clipboard.read() button availability
      const canClipboardRead = !!(navigator.clipboard && 'read' in navigator.clipboard);
      async function pasteFromClipboardApi() {
        try {
          const items = await navigator.clipboard.read();
          for (const item of items) {
            for (const type of item.types) {
              if (type.startsWith('image/')) {
                const blob = await item.getType(type);
                loadBlob(blob);
                return;
              }
            }
          }
          alert('Hittade ingen bild i urklipp.');
        } catch (e) {
          alert('Kunde inte läsa från urklipp: ' + e);
        }
      }

      // Ritning
      useEffect(() => {
        const canvas = canvasRef.current;
        const img = imgRef.current;
        if (!canvas || !img || !image) return;
        const ctx = canvas.getContext("2d");
        if (!ctx) return;

        const maxW = Math.min(1000, window.innerWidth - 64);
        const ratio = img.naturalWidth / img.naturalHeight;
        const w = maxW;
        const h = Math.round(w/ratio);
        canvas.width = w; canvas.height = h;

        ctx.clearRect(0,0,w,h);
        ctx.drawImage(img,0,0,w,h);

        const drawPoint = (p, label) => {
          if (!p) return;
          ctx.beginPath();
          ctx.arc(p.x, p.y, 6, 0, Math.PI*2);
          ctx.fill();
          ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto";
          ctx.fillText(label, p.x + 8, p.y - 8);
        };

        ctx.save(); ctx.globalAlpha = 0.8;
        drawPoint(calTopY!=null?{x:12,y:calTopY}:null, "0 dB");
        drawPoint(calBottomY!=null?{x:12,y:calBottomY}:null, bottomDb + " dB");
        ctx.restore();

        ctx.save(); ctx.globalAlpha = 0.9;
        drawPoint(pt3, "3 kHz");
        drawPoint(pt4, "4 kHz");
        drawPoint(pt6, "6 kHz");
        ctx.restore();
      }, [image, calTopY, calBottomY, pt3, pt4, pt6, bottomDb]);

      function imgClick(e) {
        const canvas = canvasRef.current;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        if (calTopY===null) { setCalTopY(y); return; }
        if (calBottomY===null) { setCalBottomY(y); return; }
        if (!pt3) { setPt3({x,y}); return; }
        if (!pt4) { setPt4({x,y}); return; }
        if (!pt6) { setPt6({x,y}); return; }
      }

      function clearAll() {
        setCalTopY(null); setCalBottomY(null); setPt3(null); setPt4(null); setPt6(null);
        setThresholds({});
      }

      function yToDb(y) {
        if (calTopY==null || calBottomY==null) return NaN;
        const frac = (y - calTopY) / (calBottomY - calTopY);
        return topDb + frac * (bottomDb - topDb);
      }

      useEffect(() => {
        if (pt3 && pt4 && pt6 && calTopY!=null && calBottomY!=null) {
          const k3 = yToDb(pt3.y);
          const k4 = yToDb(pt4.y);
          const k6 = yToDb(pt6.y);
          setThresholds({k3, k4, k6});
        }
      }, [pt3, pt4, pt6, calTopY, calBottomY, topDb, bottomDb]);

      const age = (() => {
        if (!birthYear || String(birthYear).length!==4) return undefined;
        return new Date().getFullYear() - Number(birthYear);
      })();
      const ageRounded = age!=null ? round5(age) : undefined;

      const dtmv = (() => {
        const {k3,k4,k6} = thresholds;
        if (k3==null || k4==null || k6==null) return undefined;
        return (k3+k4+k6)/3;
      })();
      const dtmvRounded = dtmv!=null ? round5(dtmv) : undefined;

      const tib = (() => {
        if (ageRounded==null || dtmvRounded==null) return undefined;
        const ageKey = nearestLower(AGE_BINS, ageRounded);
        const dbKey = nearestLower(DTMV_BINS, dtmvRounded);
        const idx = DTMV_BINS.indexOf(dbKey);
        return MATRIX[ageKey][idx];
      })();

      async function copyTib() {
        if (tib==null) return;
        await navigator.clipboard.writeText(String(tib));
        alert("Kopierat: " + tib + "%");
      }

      return React.createElement('div', {className:'p-6 max-w-6xl mx-auto space-y-4'},
        React.createElement('h1', {className:'text-2xl font-bold'}, 'Audiogram → TIB (FB S/N+4)'),
        React.createElement('div', {className:'grid gap-4 md:grid-cols-3'},

          // Vänster: bild
          React.createElement('div', {className:'md:col-span-2 p-4 border rounded-2xl', ref:dropRef},
            React.createElement('div', {className:'flex items-center gap-3 mb-3 flex-wrap'},
              React.createElement('input', {type:'file', accept:'image/*', onChange:(e)=>{ handleFile(e.target.files?.[0]); }}),
              image && React.createElement('button', {className:'px-3 py-1 rounded-xl border', onClick:()=>{setImage(null); clearAll();}}, 'Rensa bild'),
              (!!(navigator.clipboard && 'read' in navigator.clipboard)) &&
                React.createElement('button', {className:'px-3 py-1 rounded-xl border', onClick:pasteFromClipboardApi}, 'Klistra in från urklipp'),
              React.createElement('span', {className:'text-xs opacity-70'}, 'Tips: Släpp bild här eller tryck ', 
                React.createElement('code', {className:'px-1 border rounded bg-gray-50'}, 'Ctrl+V'), '.')
            ),
            image ? React.createElement(React.Fragment, null,
              React.createElement('img', {ref:imgRef, src:image, className:'hidden'}),
              React.createElement('canvas', {ref:canvasRef, onClick:imgClick, className:'cursor-crosshair rounded-xl shadow w-full'}),
              React.createElement('p', {className:'text-sm mt-2 opacity-80'}, `Klick-ordning: 1) 0 dB-linjen. 2) Nedersta linjen (${bottomDb} dB). 3) 3 kHz. 4) 4 kHz. 5) 6 kHz.`)
            ) : React.createElement('div', {className:\`p-8 text-sm rounded-xl border-2 \${dropActive?'border-blue-500 bg-blue-50':'border-dashed border-gray-300 bg-gray-50'} text-center\`},
                'Släpp bild här, välj fil, eller ', React.createElement('b', null, 'Ctrl+V'), ' för att klistra in skärmdump.')
          ),

          // Höger: parametrar & resultat
          React.createElement('div', {className:'p-4 border rounded-2xl space-y-3'},
            React.createElement('div', null,
              React.createElement('label', {className:'block text-sm mb-1'}, 'Födelseår'),
              React.createElement('input', {className:'w-full border rounded-xl px-3 py-2', placeholder:'t.ex. 1993',
                value:birthYear, onChange:(e)=>setBirthYear(e.target.value)})
            ),
            React.createElement('div', {className:'grid grid-cols-2 gap-3'},
              React.createElement('div', null,
                React.createElement('label', {className:'block text-sm mb-1'}, 'Topp dB (y-axel)'),
                React.createElement('input', {type:'number', className:'w-full border rounded-xl px-3 py-2', value:topDb,
                  onChange:(e)=>setTopDb(Number(e.target.value))})
              ),
              React.createElement('div', null,
                React.createElement('label', {className:'block text-sm mb-1'}, 'Botten dB (y-axel)'),
                React.createElement('input', {type:'number', className:'w-full border rounded-xl px-3 py-2', value:bottomDb,
                  onChange:(e)=>setBottomDb(Number(e.target.value))})
              )
            ),
            React.createElement('div', {className:'text-sm bg-gray-50 rounded-xl p-3'},
              React.createElement('div', {className:'font-semibold mb-1'}, 'Avlästa trösklar (dB HL)'),
              React.createElement('div', null, '3 kHz: ', thresholds.k3!=null ? thresholds.k3.toFixed(1) : '–'),
              React.createElement('div', null, '4 kHz: ', thresholds.k4!=null ? thresholds.k4.toFixed(1) : '–'),
              React.createElement('div', null, '6 kHz: ', thresholds.k6!=null ? thresholds.k6.toFixed(1) : '–')
            ),
            React.createElement('div', {className:'text-sm bg-gray-50 rounded-xl p-3'},
              React.createElement('div', null, 'Ålder (avrundad 5 år): ', React.createElement('b', null, ageRounded ?? '–')),
              React.createElement('div', null, 'DTMV 3/4/6 (medel): ', React.createElement('b', null, dtmv!=null ? dtmv.toFixed(1) + ' dB' : '–')),
              React.createElement('div', null, 'DTMV avrundad (5 dB): ', React.createElement('b', null, dtmvRounded ?? '–', dtmvRounded!=null ? ' dB' : ''))
            ),
            React.createElement('div', {className:'text-lg flex items-center gap-2 flex-wrap'},
              React.createElement('span', null, 'Förväntat tal-i-brus (FB S/N+4): '),
              tib!=null ? React.createElement('b', {className:'text-xl'}, tib + '%') : '–',
              tib!=null ? React.createElement('button', {className:'px-2 py-1 rounded-lg border', onClick:copyTib}, 'Kopiera') : null
            ),
            React.createElement('div', {className:'flex gap-2'},
              React.createElement('button', {className:'px-3 py-1 rounded-xl border', onClick:clearAll}, 'Rensa klick')
            ),
            React.createElement('p', {className:'text-xs opacity-70'}, 'Om audiogrammet har annan skala (t.ex. topp = −10 dB, botten = 110 dB), ändra fälten ovan och kalibrera om (klicka först på 0 dB och nedersta linjen).')
          )
        )
      );
    }

    createRoot(document.getElementById('root')).render(React.createElement(App));
  </script>
</body>
</html>

